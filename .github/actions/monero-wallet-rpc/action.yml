name: monero-wallet-rpc
description: Spawns a Monero Wallet-RPC

inputs:
  version:
    description: "Version to download and run"
    required: false
    default: v0.18.4.4

runs:
  using: "composite"
  steps:
    - name: Monero Wallet RPC Cache
      id: cache-monero-wallet-rpc
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # 4.2.4
      with:
        path: monero-wallet-rpc*
        key: monero-wallet-rpc-${{ runner.os }}-${{ runner.arch }}-${{ inputs.version }}

    - name: Download the Monero Wallet RPC
      if: steps.cache-monero-wallet-rpc.outputs.cache-hit != 'true'
      # Calculates OS/ARCH to demonstrate it, yet then locks to linux-x64 due
      # to the contained folder not following the same naming scheme and
      # requiring further expansion not worth doing right now
      shell: bash
      run: |
        OS=${{ runner.os }}
        ARCH=${{ runner.arch }}

        OS=$(echo "$OS" | tr "[:upper:]" "[:lower:]")
        ARCH=$(echo "$ARCH" | tr "[:upper:]" "[:lower:]")
        EXT="tar.bz2"

        if [ "$OS" = "windows" ]; then
          OS="win"
          EXT="zip"
        fi
        if [ "$ARCH" = "arm64" ]; then
          ARCH="armv8"
        fi
        if [ "$OS" = "macos" ]; then
          OS="mac"
          # If this is an ARM macOS downloading a historic version, download x64 to run via Rosetta
          if [ $(echo "${{ inputs.version }}" | cut -d'.' -f2) -lt 18 ]; then
            ARCH="x64"
          fi
        fi

        FILE=monero-$OS-$ARCH-${{ inputs.version }}.$EXT
        mkdir monero-wallet-tmp
        cd monero-wallet-tmp
        curl -L https://downloads.getmonero.org/cli/$FILE -o $FILE
        if [ "$EXT" = "tar.bz2" ]; then
          tar -xf $FILE
        fi
        if [ "$EXT" = "zip" ]; then
          unzip $FILE
        fi
        cd ..

        mv $(find . -type f -name "monero-wallet-rpc*") .
        rm -rf monero-wallet-tmp

    - name: Monero Wallet RPC
      shell: bash
      run: |
        COMMAND="./monero-wallet-rpc --allow-mismatched-daemon-version
          --daemon-login monero:oxide
          --rpc-bind-port 18083 --disable-rpc-login
          --wallet-dir $(pwd)"

        if [ "${{ runner.os }}" = "Windows" ]; then
          $COMMAND --install-service
          $COMMAND --start-service
        else
          $COMMAND --detach
        fi
